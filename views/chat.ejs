<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alumni Connect Chat</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial; display: flex; height: 100vh; margin: 0; }
    .sidebar { width: 25%; border-right: 1px solid #ccc; background: #f7f7f7; padding: 1rem; overflow-y: auto; }
    .chat { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem; background: #fff; }
    .msg { margin-bottom: 10px; }
    .msg span { font-weight: bold; }
    .input-box { display: flex; border-top: 1px solid #ccc; }
    input { flex: 1; padding: 10px; }
    button { background: #007bff; color: white; border: none; padding: 10px 15px; }
    .user { cursor: pointer; padding: 8px; border-radius: 5px; }
    .user:hover { background: #eaeaea; }
    .active { background: #d0ebff; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Chat Users</h3>
    <button id="publicBtn" style="margin-bottom: 10px;">üåê Common Discussion</button>
    <ul id="userList">
      <% users.forEach(u => { %>
        <li class="user" data-id="<%= u._id %>"><%= u.name %></li>
      <% }) %>
    </ul>
  </div>

  <div class="chat">
    <div id="messages" class="messages"></div>
    <form id="chatForm" class="input-box">
      <input id="messageInput" placeholder="Type message..." autocomplete="off" />
      <button>Send</button>
    </form>
  </div>

  <script>
    const socket = io();
    const currUserId = "<%= user._id %>";
    const currUserName = "<%= user.name %>";

    let currentRoom = "common-room";
    let chatType = "public";
    let receiverId = null;

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("messageInput");
    const form = document.getElementById("chatForm");
    const users = document.querySelectorAll(".user");
    const publicBtn = document.getElementById("publicBtn");

    // Switch to public chat
    publicBtn.addEventListener("click", () => {
      chatType = "public";
      receiverId = null;
      currentRoom = "common-room";
      messagesDiv.innerHTML = "";
    });

    // Switch to private chat
    users.forEach((user) => {
      user.addEventListener("click", () => {
        users.forEach(u => u.classList.remove("active"));
        user.classList.add("active");

        receiverId = user.dataset.id;
        chatType = "private";
        socket.emit("joinPrivateRoom", { senderId: currUserId, receiverId });
        messagesDiv.innerHTML = `<em>Private chat with ${user.textContent}</em><hr>`;
      });
    });

    // Receive public message
    socket.on("publicMessage", (data) => {
      const div = document.createElement("div");
      div.classList.add("msg");
      div.innerHTML = `<span>${data.sender.name}</span>: ${data.content}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Receive private message
    socket.on("privateMessage", (data) => {
      const div = document.createElement("div");
      div.classList.add("msg");
      div.innerHTML = `<span>${data.sender.name}</span>: ${data.content}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Load chat history
    socket.on("chatHistory", (msgs) => {
      messagesDiv.innerHTML = "";
      msgs.forEach((m) => {
        const div = document.createElement("div");
        div.classList.add("msg");
        div.innerHTML = `<span>${m.sender.name}</span>: ${m.content}`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Send message
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      if (chatType === "public") {
        socket.emit("publicMessage", { userId: currUserId, message });
      } else {
        socket.emit("privateMessage", {
          senderId: currUserId,
          receiverId,
          message,
        });
      }
      input.value = "";
    });
  </script>
</body>
</html>
